# 故障排除指南

## 常见问题及解决方案

### ❌ 问题1: WXML file not found

**错误信息：**
```
WXML file not found: ./pages/diet/diet.wxml
```

**原因：**
- 项目配置问题
- 缓存问题
- npm 构建问题

**解决方案：**

#### 方法一：清除缓存并重新编译（推荐）

1. 在微信开发者工具中，点击顶部菜单栏
2. 选择 `工具` -> `清除缓存` -> `全部清除`
3. 点击 `工具` -> `构建 npm`（等待完成）
4. 点击 `编译` 按钮重新编译

#### 方法二：检查项目配置

1. 点击右上角 `详情` 按钮
2. 进入 `本地设置` 标签
3. 确保以下选项已勾选：
   - ✅ 使用 npm 模块
   - ✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
   - ✅ ES6 转 ES5
   - ✅ 增强编译
   - ✅ 上传代码时样式自动补全
   - ✅ 上传代码时自动压缩

#### 方法三：重新导入项目

1. 关闭微信开发者工具
2. 删除项目根目录下的 `.idea` 文件夹（如果有）
3. 重新打开微信开发者工具
4. 重新导入项目
5. 执行 `工具` -> `构建 npm`
6. 编译运行

---

### ❌ 问题2: __route__ is not defined

**错误信息：**
```
ReferenceError: __route__ is not defined
```

**原因：**
- 自定义 TabBar 初始化问题
- 页面加载顺序问题

**解决方案：**

已在代码中修复，确保以下文件内容正确：

**src/custom-tab-bar/index.js**
```javascript
// custom-tab-bar/index.js
Component({
  data: {
    active: 0,
    list: [
      {
        pagePath: '/pages/index/index',
        text: '首页',
        icon: '🏠',
      },
      {
        pagePath: '/pages/health/health',
        text: '健康',
        icon: '📊',
      },
      {
        pagePath: '/pages/profile/profile',
        text: '我的',
        icon: '👤',
      },
    ],
  },

  methods: {
    onChange(event) {
      const { index } = event.currentTarget.dataset;
      const item = this.data.list[index];
      
      wx.switchTab({
        url: item.pagePath,
      });
      
      this.setData({ active: index });
    },

    init() {
      const page = getCurrentPages().pop();
      if (!page) return;
      
      const route = page.route;
      const active = this.data.list.findIndex(item => item.pagePath === `/${route}`);
      
      this.setData({ active: active === -1 ? 0 : active });
    },
  },
});
```

---

### ❌ 问题3: npm 构建失败

**错误信息：**
```
构建 npm 失败
```

**解决方案：**

#### 步骤1: 检查 package.json

确保 `src/package.json` 文件存在且内容正确：

```json
{
  "name": "health-partner-miniapp",
  "version": "1.0.0",
  "description": "健康伙伴小程序",
  "main": "app.js",
  "dependencies": {
    "@vant/weapp": "^1.11.6"
  }
}
```

#### 步骤2: 重新安装依赖

在终端中执行：

```bash
cd /Users/daimin/whpuedison/code/health-partner/src
rm -rf node_modules
rm package-lock.json
npm install
```

#### 步骤3: 微信开发者工具设置

1. 点击 `详情` -> `本地设置`
2. 勾选 `使用 npm 模块`
3. 点击 `工具` -> `构建 npm`

---

### ❌ 问题4: 页面样式错乱

**原因：**
- Vant Weapp 样式未加载
- 全局样式冲突

**解决方案：**

#### 检查 app.wxss 中的 import 语句

确保第一行是：
```css
@import './miniprogram_npm/@vant/weapp/common/index.wxss';
```

#### 重新构建

1. `工具` -> `构建 npm`
2. 清除缓存
3. 重新编译

---

### ❌ 问题5: TabBar 不显示

**原因：**
- 自定义 TabBar 文件缺失
- TabBar 配置错误

**解决方案：**

#### 检查文件是否完整

确保以下文件存在：
- `src/custom-tab-bar/index.js`
- `src/custom-tab-bar/index.wxml`
- `src/custom-tab-bar/index.wxss`
- `src/custom-tab-bar/index.json`

#### 检查 app.json 配置

```json
{
  "tabBar": {
    "custom": true,
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页"
      },
      {
        "pagePath": "pages/health/health",
        "text": "健康"
      },
      {
        "pagePath": "pages/profile/profile",
        "text": "我的"
      }
    ]
  }
}
```

---

### ❌ 问题6: 数据不保存

**原因：**
- 本地存储限制
- 代码逻辑问题

**解决方案：**

#### 检查存储空间

小程序本地存储限制为 10MB，检查是否超限：

```javascript
// 在控制台执行
const info = wx.getStorageInfoSync();
console.log('当前存储:', info);
```

#### 清除所有数据

在"个人中心"页面点击 `清除所有数据` 按钮

---

## 🔍 调试技巧

### 1. 查看控制台日志

在微信开发者工具中：
- 点击底部 `Console` 标签
- 查看错误信息和警告
- 使用 `console.log()` 输出调试信息

### 2. 审查元素

- 点击 `Wxml` 标签查看页面结构
- 点击 `AppData` 标签查看数据
- 点击 `Storage` 标签查看本地存储

### 3. 真机调试

1. 点击工具栏的 `真机调试` 按钮
2. 使用微信扫码
3. 在真机上查看效果
4. 通过 vConsole 查看日志

### 4. 使用断点调试

1. 在 `Sources` 标签中打开 JS 文件
2. 点击行号添加断点
3. 重新触发相关操作
4. 逐步执行代码

---

## 📞 还是无法解决？

### 检查清单

- [ ] 已清除所有缓存
- [ ] 已重新构建 npm
- [ ] 已重新编译项目
- [ ] 已检查控制台错误信息
- [ ] 已确认所有文件存在
- [ ] 已检查本地设置配置
- [ ] 已尝试重新导入项目

### 获取帮助

1. 查看控制台具体错误信息
2. 截图错误信息
3. 记录操作步骤
4. 检查微信开发者工具版本（建议使用最新稳定版）

### 最后的办法

如果以上方法都无法解决，尝试：

1. **更新微信开发者工具**
   - 下载最新稳定版
   - 重新打开项目

2. **重新克隆项目**
   - 备份当前项目
   - 重新下载/克隆代码
   - 重新安装依赖

3. **换一台电脑试试**
   - 排除环境问题

---

## ✅ 验证修复成功

修复后，应该能看到：

1. ✅ 首页正常显示
2. ✅ 底部 TabBar 正常显示
3. ✅ 可以正常切换页面
4. ✅ 点击快捷功能可以跳转
5. ✅ 数据可以正常保存和读取
6. ✅ 样式显示正常

---

**健康伙伴 v1.0.0**  
最后更新：2025年11月9日

