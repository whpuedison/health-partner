<!--pages/timeline/timeline.wxml-->
<view class="timeline-page">
  <!-- å‘å¸ƒæŒ‰é’® -->
  <view class="create-btn" bindtap="goToCreate">
    <text class="create-icon">âœï¸</text>
    <text class="create-text">å‘å¸ƒ</text>
  </view>

  <!-- å¸–å­åˆ—è¡¨ -->
  <view class="posts-list">
    <view class="post-item" wx:for="{{posts}}" wx:key="id">
      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <view class="post-header">
        <image class="user-avatar" src="{{item.avatar_url || '/static/default-avatar.png'}}" mode="aspectFill"></image>
        <view class="user-info">
          <text class="user-name">{{item.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
          <text class="post-time">{{item.created_at}}</text>
        </view>
        <!-- æ—¶å…‰è½´ä¸­æ‰€æœ‰å¸–å­éƒ½æ˜¾ç¤ºåˆ é™¤æŒ‰é’® -->
        <view class="post-actions">
          <text class="delete-btn" data-id="{{item.id}}" bindtap="deletePost">åˆ é™¤</text>
        </view>
      </view>

      <!-- å¸–å­å†…å®¹ -->
      <view class="post-content">
        <text class="content-text">{{item.content}}</text>
      </view>

      <!-- å¸–å­å›¾ç‰‡ -->
      <view class="post-images" wx:if="{{item.images && item.images.length > 0}}">
        <!-- å•å¼ å›¾ç‰‡ -->
        <view class="images-grid images-single" wx:if="{{item.images.length === 1}}">
          <image 
            class="image-single" 
            src="{{item.images[0]}}" 
            mode="widthFix"
            data-url="{{item.images[0]}}"
            data-urls="{{item.images}}"
            bindtap="previewImage"
          ></image>
        </view>
        <!-- 2å¼ å›¾ç‰‡ -->
        <view class="images-grid images-2" wx:elif="{{item.images.length === 2}}">
          <view 
            class="image-item" 
            wx:for="{{item.images}}" 
            wx:key="*this"
            wx:for-item="img"
            data-url="{{img}}"
            data-urls="{{item.images}}"
            bindtap="previewImage"
          >
            <image 
              src="{{img}}" 
              mode="aspectFill"
            ></image>
          </view>
        </view>
        <!-- 3-4å¼ å›¾ç‰‡ï¼š2x2ç½‘æ ¼ -->
        <view class="images-grid images-4" wx:elif="{{item.images.length <= 4}}">
          <view 
            class="image-item" 
            wx:for="{{item.images}}" 
            wx:key="*this"
            wx:for-item="img"
            data-url="{{img}}"
            data-urls="{{item.images}}"
            bindtap="previewImage"
          >
            <image 
              src="{{img}}" 
              mode="aspectFill"
            ></image>
          </view>
        </view>
        <!-- 5-6å¼ å›¾ç‰‡ï¼š3åˆ— -->
        <view class="images-grid images-6" wx:elif="{{item.images.length <= 6}}">
          <view 
            class="image-item" 
            wx:for="{{item.images}}" 
            wx:key="*this"
            wx:for-item="img"
            data-url="{{img}}"
            data-urls="{{item.images}}"
            bindtap="previewImage"
          >
            <image 
              src="{{img}}" 
              mode="aspectFill"
            ></image>
          </view>
        </view>
        <!-- 7-9å¼ å›¾ç‰‡ï¼š3x3ç½‘æ ¼ -->
        <view class="images-grid images-9" wx:else>
          <view 
            class="image-item" 
            wx:for="{{item.images}}" 
            wx:key="*this"
            wx:for-item="img"
            data-url="{{img}}"
            data-urls="{{item.images}}"
            bindtap="previewImage"
          >
            <image 
              src="{{img}}" 
              mode="aspectFill"
            ></image>
          </view>
        </view>
      </view>

      <!-- äº’åŠ¨åŒºåŸŸï¼šç‚¹èµå’Œè¯„è®º -->
      <view class="post-actions-bar">
        <view class="action-item" bindtap="toggleLike" data-id="{{item.id}}">
          <text class="action-icon {{item.isLiked ? 'liked' : ''}}">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          <text class="action-text">{{item.likeCount || 0}}</text>
        </view>
        <view class="action-item" bindtap="toggleComments" data-id="{{item.id}}">
          <text class="action-icon">ğŸ’¬</text>
          <text class="action-text">{{item.commentCount || 0}}</text>
        </view>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view class="comments-section" wx:if="{{item.showComments}}">
        <!-- è¯„è®ºè¾“å…¥æ¡† -->
        <view class="comment-input-box" wx:if="{{item.showCommentInput}}">
          <view class="comment-input-hint" wx:if="{{item.commentInput && item.commentInput.replyToNickname}}">
            å›å¤ {{item.commentInput.replyToNickname}}ï¼š
          </view>
          <view class="comment-input-row">
            <input 
              class="comment-input" 
              placeholder="å†™è¯„è®º..."
              value="{{item.commentInput && item.commentInput.content}}"
              data-id="{{item.id}}"
              bindinput="onCommentInput"
              confirm-type="send"
              bindconfirm="submitComment"
            />
            <text class="comment-submit" data-id="{{item.id}}" bindtap="submitComment">å‘é€</text>
            <text class="comment-cancel" data-id="{{item.id}}" bindtap="hideCommentInput">å–æ¶ˆ</text>
          </view>
        </view>
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view class="comments-list" wx:if="{{item.comments && item.comments.length > 0}}">
          <view class="comment-item" wx:for="{{item.comments}}" wx:key="id" wx:for-item="comment">
            <!-- ä¸€çº§è¯„è®º -->
            <view class="comment-main">
              <image class="comment-avatar" src="{{comment.avatarUrl || '/static/default-avatar.png'}}" mode="aspectFill"></image>
              <view class="comment-content">
                <view class="comment-header">
                  <text class="comment-name">{{comment.nickname}}</text>
                  <text class="comment-time">{{comment.created_at}}</text>
                </view>
                <text class="comment-text">{{comment.content}}</text>
                <view class="comment-actions">
                  <text class="comment-reply" data-id="{{item.id}}" data-parent-id="{{comment.id}}" data-reply-to-user-id="{{comment.userId}}" data-reply-to-nickname="{{comment.nickname}}" bindtap="showCommentInput">å›å¤</text>
                </view>
              </view>
            </view>
            
            <!-- äºŒçº§è¯„è®ºï¼ˆå›å¤ï¼‰ -->
            <view class="comment-replies" wx:if="{{comment.replies && comment.replies.length > 0}}">
              <view class="reply-item" wx:for="{{comment.replies}}" wx:key="id" wx:for-item="reply">
                <image class="reply-avatar" src="{{reply.avatarUrl || '/static/default-avatar.png'}}" mode="aspectFill"></image>
                <view class="reply-content">
                  <view class="reply-header">
                    <text class="reply-name">{{reply.nickname}}</text>
                    <text class="reply-hint" wx:if="{{reply.replyToNickname}}">å›å¤ {{reply.replyToNickname}}</text>
                    <text class="reply-time">{{reply.created_at}}</text>
                  </view>
                  <text class="reply-text">{{reply.content}}</text>
                  <view class="reply-actions">
                    <text class="reply-reply" data-id="{{item.id}}" data-parent-id="{{comment.id}}" data-reply-to-user-id="{{reply.userId}}" data-reply-to-nickname="{{reply.nickname}}" bindtap="showCommentInput">å›å¤</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- æ·»åŠ è¯„è®ºæŒ‰é’® -->
        <view class="add-comment-btn" bindtap="showCommentInput" data-id="{{item.id}}">
          <text>å†™è¯„è®º...</text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-more" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    <view class="no-more" wx:if="{{!hasMore && posts.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
    <view class="empty-state" wx:if="{{!loading && posts.length === 0}}">
      <text class="empty-icon">ğŸ“­</text>
      <text class="empty-text">è¿˜æ²¡æœ‰å‘å¸ƒè¿‡å¸–å­ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§~</text>
    </view>
  </view>
</view>

