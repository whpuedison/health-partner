<!--pages/diet/diet.wxml-->
<view class="diet-page">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">é¥®é£Ÿè®¡åˆ’</text>
    <text class="page-subtitle">è®°å½•æ¯ä¸€é¤ï¼ŒæŒæ¡è¥å…»æ‘„å…¥</text>
  </view>

  <!-- å¡è·¯é‡Œæ€»è§ˆ -->
  <view class="calorie-card">
    <view class="calorie-main">
      <text class="calorie-value">{{totalCalories}}</text>
      <text class="calorie-unit">/ {{targetCalories}} å¡</text>
    </view>
    <view class="calorie-progress">
      <view class="calorie-fill" style="width: {{totalCalories / targetCalories * 100}}%"></view>
    </view>
    <view class="calorie-status">
      <text>{{totalCalories >= targetCalories ? 'å·²è¾¾æ ‡ âœ“' : 'å‰©ä½™ ' + (targetCalories - totalCalories) + ' å¡'}}</text>
    </view>
  </view>

  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tabs">
    <view 
      class="tab-item {{activeTab === index ? 'active' : ''}}" 
      wx:for="{{tabs}}" 
      wx:key="index"
      data-index="{{index}}"
      bindtap="onTabChange"
    >
      {{item}}
    </view>
  </view>

  <!-- ä»Šæ—¥è®°å½• -->
  <view class="tab-content" wx:if="{{activeTab === 0}}">
    <!-- å¿«æ·æ·»åŠ  -->
    <view class="quick-meals">
      <view 
        class="meal-btn" 
        wx:for="{{quickMeals}}" 
        wx:key="name"
        style="background: {{item.color}}20; border-color: {{item.color}};"
        data-type="{{item.name}}"
        bindtap="openAddDialog"
      >
        <text class="meal-icon">{{item.icon}}</text>
        <text class="meal-name">{{item.name}}</text>
        <text class="meal-time">{{item.time}}</text>
      </view>
    </view>

    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="records-list" wx:if="{{todayRecords.length > 0}}">
      <view class="record-item" wx:for="{{todayRecords}}" wx:key="id">
        <text class="record-icon">{{item.foodIcon}}</text>
        <view class="record-info">
          <view class="record-name-row">
            <text class="record-name">{{item.food}}</text>
            <text class="record-meal">{{item.mealType}}</text>
          </view>
          <text class="record-time">{{item.time}}</text>
        </view>
        <view class="record-stats">
          <text class="record-stat">{{item.calories}}å¡</text>
        </view>
        <text class="delete-btn" data-id="{{item.id}}" bindtap="deleteRecord">âœ•</text>
      </view>
    </view>

    <view class="empty-state" wx:else>
      <text class="empty-icon">ğŸ½ï¸</text>
      <text class="empty-text">è¿˜æ²¡æœ‰è®°å½•ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ ä»Šæ—¥é¥®é£Ÿ</text>
    </view>
  </view>

  <!-- æ¨èé£Ÿè°±ï¼ˆæš‚æ—¶éšè—ï¼‰ -->
  <view class="tab-content" wx:if="false">
    <view class="recipe-grid">
      <view class="recipe-card" wx:for="{{recommendations}}" wx:key="id">
        <image class="recipe-image" src="{{item.image}}" mode="aspectFill"></image>
        <view class="recipe-info">
          <text class="recipe-name">{{item.name}}</text>
          <view class="recipe-tags">
            <text class="recipe-tag">{{item.category}}</text>
            <text class="recipe-tag">{{item.calories}}å¡</text>
          </view>
          <text class="recipe-desc">{{item.description}}</text>
        </view>
        <view class="recipe-actions">
          <button class="recipe-btn detail" data-recipe="{{item}}" bindtap="viewRecipeDetail">æŸ¥çœ‹è¯¦æƒ…</button>
          <button class="recipe-btn primary" data-recipe="{{item}}" bindtap="useRecipe">ä½¿ç”¨</button>
        </view>
      </view>
    </view>
  </view>

  <!-- è¥å…»åˆ†æ -->
  <view class="tab-content" wx:if="{{activeTab === 1}}">
    <view class="nutrition-card">
      <text class="nutrition-title">ä»Šæ—¥è¥å…»æ‘„å…¥</text>
      
      <view class="nutrition-item">
        <view class="nutrition-header">
          <text class="nutrition-name">ğŸ¥© è›‹ç™½è´¨</text>
          <text class="nutrition-value">{{nutrition.protein}}g</text>
        </view>
        <view class="nutrition-bar">
          <view class="nutrition-fill protein" style="width: {{nutrition.protein / 100 * 100}}%"></view>
        </view>
      </view>

      <view class="nutrition-item">
        <view class="nutrition-header">
          <text class="nutrition-name">ğŸš ç¢³æ°´åŒ–åˆç‰©</text>
          <text class="nutrition-value">{{nutrition.carbs}}g</text>
        </view>
        <view class="nutrition-bar">
          <view class="nutrition-fill carbs" style="width: {{nutrition.carbs / 250 * 100}}%"></view>
        </view>
      </view>

      <view class="nutrition-item">
        <view class="nutrition-header">
          <text class="nutrition-name">ğŸ¥‘ è„‚è‚ª</text>
          <text class="nutrition-value">{{nutrition.fat}}g</text>
        </view>
        <view class="nutrition-bar">
          <view class="nutrition-fill fat" style="width: {{nutrition.fat / 70 * 100}}%"></view>
        </view>
      </view>

      <view class="nutrition-item">
        <view class="nutrition-header">
          <text class="nutrition-name">ğŸŒ¾ è†³é£Ÿçº¤ç»´</text>
          <text class="nutrition-value">{{nutrition.fiber}}g</text>
        </view>
        <view class="nutrition-bar">
          <view class="nutrition-fill fiber" style="width: {{nutrition.fiber / 30 * 100}}%"></view>
        </view>
      </view>
    </view>

    <view class="nutrition-tips">
      <text class="tips-title">ğŸ’¡ è¥å…»å»ºè®®</text>
      <text class="tips-text">â€¢ å»ºè®®æ¯æ—¥è›‹ç™½è´¨æ‘„å…¥çº¦ 100g</text>
      <text class="tips-text">â€¢ ç¢³æ°´åŒ–åˆç‰©æ§åˆ¶åœ¨ 250g å·¦å³</text>
      <text class="tips-text">â€¢ è„‚è‚ªæ‘„å…¥ä¸è¶…è¿‡ 70g</text>
      <text class="tips-text">â€¢ è†³é£Ÿçº¤ç»´è‡³å°‘ 25-30g</text>
    </view>
  </view>

  <!-- æ·»åŠ å¯¹è¯æ¡† - çº§è”é€‰æ‹© -->
  <view class="dialog-mask" wx:if="{{showAddDialog}}" bindtap="closeAddDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">æ·»åŠ {{currentMealType}}</text>
        <text class="dialog-close" bindtap="closeAddDialog">âœ•</text>
      </view>
      
      <view class="dialog-body">
        <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©åˆ†ç±» -->
        <view class="cascade-step" wx:if="{{dialogStep === 'category'}}">
          <text class="step-title">é€‰æ‹©é£Ÿç‰©åˆ†ç±»</text>
          <view class="category-list">
            <view 
              class="category-item" 
              wx:for="{{categories}}" 
              wx:key="id"
              data-id="{{item.id}}"
              bindtap="selectCategory"
            >
              <text class="category-icon">{{item.icon || 'ğŸ½ï¸'}}</text>
              <text class="category-name">{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- ç¬¬äºŒæ­¥ï¼šé€‰æ‹©é£Ÿç‰© -->
        <view class="cascade-step" wx:if="{{dialogStep === 'food'}}">
          <view class="step-header">
            <text class="step-back" bindtap="goBack">â† è¿”å›</text>
            <text class="step-title">{{selectedCategory.name}}</text>
          </view>
          
          <!-- æœç´¢æ¡† -->
          <view class="search-box">
            <input 
              class="search-input" 
              placeholder="æœç´¢é£Ÿç‰©..."
              value="{{searchKeyword}}"
              bindinput="onSearchInput"
            />
          </view>
          
          <!-- é£Ÿç‰©åˆ—è¡¨ -->
          <view class="food-list">
            <view 
              class="food-item" 
              wx:for="{{foods}}" 
              wx:key="id"
              data-id="{{item.id}}"
              bindtap="selectFood"
            >
              <text class="food-icon">{{item.icon || 'ğŸ½ï¸'}}</text>
              <view class="food-info">
                <text class="food-name">{{item.name}}</text>
                <text class="food-calories">{{item.caloriesPer100g}}å¡/100g</text>
              </view>
              <text class="food-arrow">></text>
            </view>
          </view>
        </view>

        <!-- ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©å•ä½ -->
        <view class="cascade-step" wx:if="{{dialogStep === 'unit'}}">
          <view class="step-header">
            <text class="step-back" bindtap="goBack">â† è¿”å›</text>
            <text class="step-title">{{selectedFood.name}}</text>
          </view>
          
          <!-- å•ä½åˆ—è¡¨ -->
          <view class="unit-list" wx:if="{{units.length > 0}}">
            <view 
              class="unit-item {{selectedUnit && selectedUnit.id === item.id ? 'active' : ''}}" 
              wx:for="{{units}}" 
              wx:key="id"
              data-id="{{item.id}}"
              bindtap="selectUnit"
            >
              <text class="unit-name">{{item.unitName}}</text>
              <text class="unit-weight">({{item.weightGrams}}g)</text>
            </view>
          </view>
          
          <!-- è‡ªå®šä¹‰é‡é‡ -->
          <view class="custom-weight-box">
            <text class="form-label">æˆ–è¾“å…¥è‡ªå®šä¹‰é‡é‡ï¼ˆå…‹ï¼‰</text>
            <input 
              class="form-input" 
              type="digit"
              placeholder="ä¾‹å¦‚ï¼š150"
              value="{{customWeight}}"
              bindinput="onCustomWeightInput"
            />
          </view>
          
          <!-- è®¡ç®—åçš„è¥å…»ä¿¡æ¯ -->
          <view class="nutrition-preview" wx:if="{{calculatedNutrition}}">
            <text class="preview-title">è¥å…»ä¿¡æ¯</text>
            <view class="preview-item">
              <text class="preview-label">å¡è·¯é‡Œï¼š</text>
              <text class="preview-value">{{calculatedNutrition.calories}}å¡</text>
            </view>
            <view class="preview-item">
              <text class="preview-label">è›‹ç™½è´¨ï¼š</text>
              <text class="preview-value">{{calculatedNutrition.protein}}g</text>
            </view>
            <view class="preview-item">
              <text class="preview-label">ç¢³æ°´ï¼š</text>
              <text class="preview-value">{{calculatedNutrition.carbs}}g</text>
            </view>
            <view class="preview-item">
              <text class="preview-label">è„‚è‚ªï¼š</text>
              <text class="preview-value">{{calculatedNutrition.fat}}g</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="dialog-footer">
        <button class="dialog-btn cancel" bindtap="closeAddDialog">å–æ¶ˆ</button>
        <button 
          class="dialog-btn confirm" 
          bindtap="confirmAdd"
          wx:if="{{dialogStep === 'unit' && calculatedNutrition}}"
        >ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>

